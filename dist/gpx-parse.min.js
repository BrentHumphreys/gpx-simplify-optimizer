"use strict";var assert=require("assert"),fs=require("fs"),url=require("url"),http=require("http"),https=require("https"),GpxResult=require("./gpxResult"),GpxExtent=require("./gpxExtent"),GpxWaypoint=require("./gpxWaypoint"),GpxTrack=require("./gpxTrack"),GpxMetaData=require("./gpxMetaData"),GpxRoute=require("./gpxRoute"),geomUtils=require("./geomUtils"),_getWayPoints=function(a){var b=[],c=null,d=null;if(null!==a&&void 0!==a)for(var e=0,f=a.length;f>e;e++)c=a[e],d=new GpxWaypoint(c.$.lat,c.$.lon,c.ele,c.time),b.push(d);return b},_getRoutes=function(a){var b=[],c=null;if(null!==a&&void 0!==a)for(var d=0,e=a.length;e>d;d++){for(var f=[],g=a[d],h=0,i=g.rtept.length;i>h;h++)f.push(new GpxWaypoint(g.rtept[h].$.lat,g.rtept[h].$.lon));c=new GpxRoute(a.name,a.cmt,a.desc,f),b.push(c)}return b},_getTracks=function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=[],f=a[c],g=null;f.name&&(g=f.name[0]);for(var h=0,i=f.trkseg.length;i>h;h++){for(var j,k=[],l=f.trkseg[h],m=0,n=l.trkpt.length;n>m;m++){var o=l.trkpt[m],p=o.ele;j=o.hasOwnProperty("time")?o.time:null,k.push(new GpxWaypoint(o.$.lat,o.$.lon,p,j))}e.push(k)}b.push(new GpxTrack(e,g))}return b},_ParseV10=function(a){var b=null,c=null;return b=new GpxExtent,c=new GpxMetaData(a.$.creator,a.time,b),new GpxResult(c,_getWayPoints(a.wpt),_getRoutes(a.rte),_getTracks(a.trk))},_ParseV11=function(a){var b,c;return a.metadata&&a.metadata[0]?(a.metadata[0].time&&(c=a.metadata[0].time[0]),b=new GpxMetaData(a.$.creator,c)):b=new GpxMetaData,new GpxResult(b,_getWayPoints(a.wpt),_getRoutes(a.rte),_getTracks(a.trk))};exports.parseGpx=function(a,b){var c=require("xml2js").parseString,d=null,e=null;c(a,function(a,c){if(a)return void b(a,null);try{if(!c.hasOwnProperty("gpx")||!c.gpx.hasOwnProperty("$"))return b(new Error("version not specified"),null);if(e=c.gpx.$.version,"1.0"===e)d=_ParseV10(c.gpx);else{if("1.1"!==e)return void b(new Error("version not supported"),null);d=_ParseV11(c.gpx)}b(null,d)}catch(a){return b(a)}})},exports.parseGpxFromFile=function(a,b){fs.readFile(a,function(a,c){return a?(console.log("error"),void b(a,null)):void exports.parseGpx(c,b)})},exports.parseRemoteGpxFile=function(a,b){function c(a){return b(new Error("failed to fetch gpx file: "+a.toString()))}function d(a){var c="";a.on("data",function(a){c+=a}),a.once("end",function(){exports.parseGpx(c,b)})}assert.equal(typeof a,"string","uri should be a string"),assert.equal(typeof b,"function","callback should be a function"),("https:"===url.parse(a).protocol?https:http).get(a,d).once("error",c)},exports.GpxResult=GpxResult,exports.GpxExtent=GpxExtent,exports.GpxWaypoint=GpxWaypoint,exports.GpxTrack=GpxTrack,exports.GpxMetaData=GpxMetaData,exports.GpxRoute=GpxRoute,exports.utils=geomUtils;