$(function(){function a(a){console.log("Nouveau parser gpx");var c=null;return gpxParse.parseGpx(a,function(d,e){if(d)console.log("This GPX file has no tracks. Can not load as true GPX file. Using it as JSON"),console.log(d),c=JSON.parse(a);else{for(console.log("Lecture data GPX ok : "+e.tracks.length),trackNum=0;trackNum<e.tracks.length;trackNum++){var f=e.tracks[trackNum];for(segmentNum=0;segmentNum<f.segments.length;segmentNum++){var g=f.segments[segmentNum];for(pointNum=0;pointNum<g.length;pointNum++){var h=g[pointNum];GPX_RAW_DATA[h.lat+","+h.lon]=h}}}console.log(GPX_RAW_DATA),c=b(a),console.log(c)}}),console.log(c),L.geoJson(c)}function b(a){if("string"==typeof a){var b=a.match(/<gpx/i)?"gpx":a.match(/kml/i)?"kml":"geojson";a=(new window.DOMParser).parseFromString(a,"text/xml"),a=toGeoJSON[b](a)}return a}var c=new L.Map("map",{zoomControl:!1,attributionControl:!1}).setView(L.latLng(36,-30),20).on("click",hideAll);window.map=c,L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(c),window.Layers={},window.currentLayer=null,L.control.zoom({zoomInTitle:$.t("actions.zoomin"),zoomOutTitle:$.t("actions.zoomout")}).addTo(c),L.Control.FileLayerLoad.LABEL='<i class="fa fa-folder-open"></i>',L.Control.FileLayerLoad.TITLE=$.t("actions.upload");var d=L.Control.fileLayerLoad({addToMap:!1,fitBounds:!1,fileSizeLimit:8096,parsers:{gpx:a},binaryFormats:[]}).addTo(c);GPX_RAW_DATA={},console.log(GPX_RAW_DATA),d.loader.on("data:loaded",function(a){hideAll(),window.currentLayer&&window.currentLayer.removeController();var b=new LayerOptimizer(a);b.choose(),window.Layers[b.id]=b,window.currentLayer=b,updateLayers()}).on("data:error",function(a){console.log("ERROR",a.error)}),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-download leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.download"),b.innerHTML='<i class="fa fa-download"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",chooseDownloadFormat),a},a}().addTo(c),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-view leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.view"),b.innerHTML='<i class="fa fa-eye"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",chooseViewFormat),a},a}().addTo(c),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-erase leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.clear"),b.innerHTML='<i class="fa fa-eraser"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",clearMap).on(b,"click",hideAll),a},a}().addTo(c),function(){var a=new L.Control({position:"topleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-lang leaflet-bar"),b=L.DomUtil.create("a","",a);return b.href="#",b.target="_blank",b.title=$.t("actions.lang"),$(b).addClass("first"),b.innerHTML='<i class="fa fa-flag"></i>',L.DomEvent.on(b,"click",L.DomEvent.stop).on(b,"click",showLanguage),a},a}().addTo(c),function(){var a=new L.Control({position:"bottomleft"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-stats");return a.id="stats",a.innerHTML='<span id="filename"></span><br /><span id="nodes"></span>',filename$=$("#filename",a),nodes$=$("#nodes",a),a},a}().addTo(c),initLanguage(),L.control.attribution({position:"topright",prefix:'<a href="http://leafletjs.com/">Leaflet</a> &bull; <a href="http://osm.org/" target="_blank" data-i18n="osm.contributors">'+$.t("osm.contributors")+"</a>"}).addTo(c),function(){var a=new L.Control({position:"topright"});return a.onAdd=function(){var a=L.DomUtil.create("div","leaflet-control-switcher-box leaflet-bar"),b=L.DomUtil.create("label","",a);b.href="#",b.title=$.t("actions.switchlayer"),b.innerHTML=$.t("layers.switcher");var c=L.DomUtil.create("select","leaflet-control-switcher leaflet-bar",a);return L.DomEvent.on(c,"change",function(){window.currentLayer.removeController(),window.currentLayer=window.Layers[$(this).val()],window.currentLayer.choose()}),a},a}().addTo(c),$("#slider").slider({value:0,min:0,max:.1,step:5e-5,precision:8,tooltip:"hide"}).on("slide",function(a){window.currentLayer.optimize(a.value),window.currentLayer.displayInfos()}).parent().width("100%"),$("#helpbtn").on("click",function(a){a.preventDefault(),$("#modal").modal("show")});var e=$.cookie("tour");(!e||parseInt(e)<3)&&($("#modal").modal("show"),e=(parseInt(e)||0)+1,$.cookie("tour",e,{expires:120}));var f=new Format;window.formats=f,f.loadAll(["GeoJSONFormat","GPXFormat","KMLFormat","MediawikiFormat"]),hljs.initHighlightingOnLoad()});